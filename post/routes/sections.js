// Generated by CoffeeScript 1.6.2
(function() {
  var db, findSection, moment;

  db = require('../db');

  moment = require('moment');

  exports.list = function(req, res, next) {
    return db.Sections.find({}, {
      title: 1,
      slug: 1
    }).sort('-createdDate').execFind(function(err, resp) {
      var i, section, sections, _i, _len;

      if (!err) {
        sections = [];
        for (i = _i = 0, _len = resp.length; _i < _len; i = ++_i) {
          section = resp[i];
          sections[i] = {
            title: section.title,
            slug: "/sections/" + section.slug + "/"
          };
        }
        return res.render('sectionsList', {
          sections: sections
        });
      } else {
        console.log("Error (sections): " + err);
        return res.end(JSON.stringify(err));
      }
    });
  };

  exports.new_get = function(req, res, next) {
    if (req.session.message) {
      req.session.message.editing = false;
      res.render('newSection', req.session.messages);
      return req.session.message = null;
    } else {
      return res.render('newSection', {
        editing: false
      });
    }
  };

  exports.new_post = function(req, res, next) {
    var err, newSection;

    err = [];
    if (!req.body.title || req.body.title.length < 3) {
      err.push("Name must be three characters or more.");
    }
    if (err.length > 0) {
      req.session.message = req.body;
      req.session.message._err = err;
      return res.redirect('/sections/new');
    } else {
      newSection = new db.Sections({
        title: req.body.title
      });
      return newSection.save(function(err, resp) {
        if (!err) {
          return res.redirect('/sections/');
        } else {
          console.log("Error (sections): " + err);
          return res.end(JSON.stringify(err));
        }
      });
    }
  };

  exports.edit_get = function(req, res, next) {
    if (req.session.message) {
      req.session.message.editing = true;
      res.render('newSection', req.session.messages);
      return req.session.message = null;
    } else {
      return findSection(req.params.slug, function(err, resp) {
        var send;

        if (!err) {
          if (resp) {
            send = {
              title: resp.title,
              editing: true
            };
            return res.render('newSection', send);
          } else {
            return res.render('errors/404', {
              _err: "Section not found"
            });
          }
        } else {
          console.log("Error (sections): " + err);
          return res.end(JSON.stringify(err));
        }
      });
    }
  };

  exports.edit_post = function(req, res, next) {
    var err;

    err = [];
    if (!req.body.title || req.body.title.length < 3) {
      err.push("Name must be three characters or more.");
    }
    if (err.length > 0) {
      req.session.message = req.body;
      req.session.message._err = err;
      return res.redirect("/sections/" + req.params.slug);
    } else {
      return findSection(req.params.slug, function(err, resp) {
        if (!err) {
          if (resp) {
            resp.title = req.body.title;
            return resp.save(function(err, resp) {
              if (err) {
                console.log("Error (sections): " + err);
                return res.end(JSON.stringify(err));
              } else {
                return res.redirect("/sections/");
              }
            });
          } else {
            return res.render('errors/404', {
              _err: "Article not found"
            });
          }
        } else {
          console.log("Error (sections): " + err);
          return res.end(JSON.stringify(err));
        }
      });
    }
  };

  findSection = function(slug, callback) {
    return db.Sections.findOne({
      slug: slug
    }).select({
      title: 1,
      slug: 1
    }).exec(function(err, resp) {
      return callback(err, resp);
    });
  };

}).call(this);
