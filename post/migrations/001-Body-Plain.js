// Generated by CoffeeScript 1.6.3
(function() {
  var db, es, htmlToText, up;

  db = require('../db');

  es = require('../es');

  htmlToText = require('html-to-text');

  up = function() {
    return db.Articles.find().select({
      body: 1,
      title: 1,
      slug: 1
    }).exec(function(err, articles) {
      var article, i, plain, _i, _len, _results;
      if (!err) {
        if (articles.length) {
          _results = [];
          for (i = _i = 0, _len = articles.length; _i < _len; i = ++_i) {
            article = articles[i];
            if (article != null) {
              if (article.body != null) {
                if (article.body[0] != null) {
                  if (article.body[0].body != null) {
                    plain = (htmlToText.fromString(article.body[0].body)).toString();
                    _results.push(es.index({
                      index: 'torch',
                      type: 'article',
                      body: {
                        title: article.title,
                        body: plain,
                        slug: article.slug
                      }
                    }, function(err, esresp) {
                      if (!err) {
                        article.bodyPlain = plain;
                        return article.save(function(err, resp) {
                          if (!err) {
                            console.log(JSON.stringify(esresp));
                            return console.log("Okay: " + i);
                          } else {
                            console.log("Error (articles): " + err);
                          }
                        });
                      } else {
                        console.log("Error (articles): " + err);
                      }
                    }));
                  } else {
                    _results.push(void 0);
                  }
                } else {
                  _results.push(void 0);
                }
              } else {
                _results.push(void 0);
              }
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        }
      } else {
        console.log("Error (articles): " + err);
      }
    });
  };

  up();

}).call(this);
